<!DOCTYPE HTML>
<!--
	Future Imperfect by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
  <head>
  <title>Avalon</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<!--[if lte IE 8]><script src="js/ie/html5shiv.js"></script><![endif]-->
	<link rel="stylesheet" href="/css/main.css" />
	<link rel="stylesheet" href="/css/pygments.css">
	<!--[if lte IE 9]><link rel="stylesheet" href="assets/css/ie9.css" /><![endif]-->
	<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
</head>

	<body>

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Header -->
<header id="header">
  <h1><a href="http://techctu.github.io/">Avalon</a></h1>
	<nav class="links">
    <!--
    <ul>
      <li><a href="#">Lorem</a></li>
			<li><a href="#">Ipsum</a></li>
			<li><a href="#">Feugiat</a></li>
			<li><a href="#">Tempus</a></li>
			<li><a href="#">Adipiscing</a></li>
		</ul>
  -->
	</nav>
	<nav class="main">
    <ul>
                <!--
								<li class="search">
									<a class="fa-search" href="#search">Search</a>
									<form id="search" method="get" action="#">
										<input type="text" name="query" placeholder="Search" />
									</form>
								</li>
              -->
		  <li class="menu">
		  	<a class="fa-bars" href="#menu">Menu</a>
			</li>
		</ul>
	</nav>
</header>

<!-- Menu -->
<section id="menu">
  <!-- Search -->
  <!--
  <section>
	  <form class="search" method="get" action="#">
	    <input type="text" name="query" placeholder="Search" />
		</form>
	</section>
  -->
	<!-- Links -->
	<section>
	  <ul class="links">
	    <li>
		    <a href="/acknowledgement">
				  <h3>Acknowledgement</h3>
				  <p>Acknowledgement</p>
				</a>
			</li>
    </ul>
	</section>
	<!-- Actions -->
  <!--
  <section>
	  <ul class="actions vertical">
	    <li><a href="#" class="button big fit">Log In</a></li>
    </ul>
  </section>
  -->
</section>

				<!-- Main -->
					<div id="main">

						<!-- Post -->
            <article class="post">
              <header>
                <div class="title">
                  <h2><a href="/%E6%9E%B6%E6%9E%84/2015/12/11/java%E7%B3%BBdubbozookeeper%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E8%AE%B0%E5%BD%95.html">Java系Dubbo、Zookeeper系统服务拆分记录</a></h2>
                <!-- <p>Lorem ipsum dolor amet nullam consequat etiam feugiat</p> -->
                </div>
                <div class="meta">
                  <time class="published" datetime="2015-12-11">December 11, 2015</time>
                  
                    <a href="#">架构</a>
                  

        <!--
        <a href="#" class="author"><span class="name">Jane Doe</span><img src="images/avatar.jpg" alt="" /></a>
        -->
                </div>
              </header>
              
              <p>事情发展情况总是偏离人的预想，尤其是业务发展和系统架构设计。一段时间后，一个新业务功能的上线往往伴随着几个相关功能的开发小组加班。同时甲组功能A可能依赖乙组功能B，乙组由于某个需求要更改功能B，而甲组开发新功能需要继续依赖功能B，且分配的开发时间并不一致。这样，协调起来会非常麻烦，效率也十分低下。于是，服务拆分的呼声越来越烈。经过几个月的研究、拆分、测试、上线，终于初步解决了服务间相互依赖的问题，便记录一下。
# 理想并不丰满
任何业务系统的架构都是和业务紧密关联的，当时拟定有几个业务产品，一个后台管理，自己建立用户体系和账户体系，对接外系统接口，底层提供一系列日志、事务等平台服务。这个时候，分层逻辑是这样的：</p>

<ul>
  <li>页面展现层：web、Controller。 </li>
  <li>业务逻辑层：services。</li>
  <li>平台服务层：Utils。</li>
  <li>基础设施层：Database、Logs。</li>
</ul>

<p>项目结构是这样的：</p>

<ul>
  <li>Utils：提供统一异常管理、日志服务、事务处理、服务注册和发布、日期转换等工具类。</li>
  <li>Apis：映射数据库表的domain类＋各个业务逻辑的Interfaces。</li>
  <li>Services：各个产品服务实现类。</li>
  <li>Web：MVC层，访问服务并展示页面。</li>
</ul>

<p>并且规定了Service相关的编码规范，如：</p>

<ul>
  <li>不同产品Service之间需要通过Interface调用，不能直接调用实现。</li>
  <li>所有产品业务类Service不能直接调用Dao，需要在上面封装一层基础Service。</li>
  <li>Service调用不能形成循环依赖。</li>
  <li>业务逻辑必须放在Service中，不能放在Controller里。</li>
  <li>分层结构中不允许逆向调用，即下层不允许调用上层的代码。</li>
</ul>

<p>看起来不错，然而domain呢？产品直接调用这些参数类型怎么办？各个产品Service相互调用，产品内部是否需要封装别的产品的Interface？后来才知道，这些都是坑。
# 现实很骨感
当时工期很紧，团队新组建，还要和别的团队一起开发，技术人员素质参差不齐，到后来规定执行不力，但勉勉强强没出大问题。</p>

<p>后来，只有三个产品上线，其中两个是用户体系和账户体系，也就是说真正业务部分只有产品A，其它产品都没有什么活力。这时候倒也没有什么问题。可产品是会增加的。产品增加，就会出现如下情况：</p>

<p><img src="http://7xogz7.com1.z0.glb.clouddn.com/ServiceRef.png?imageMogr2/thumbnail/770x" alt="Service变更" /></p>

<p>而且，出于项目迭代、运维管理的需要，会有上线窗口，这就导致了Service B 2.0部分代码提交，但还没有上线，Service A却需要上线的情况。更有可能有多个Service依赖不同版本的同一个Service的情况出现。这时候面临的就是一个功能的修改，都可能有好几个小组加班。</p>

<p>经过几个新产品的开发和外部接口变换导致的内部代码的调整，可以预见，随着产品的增加，整个系统内部的耦合性会急剧增加，新功能、新产品的开发会越来越困难，一个功能点可能会涉及多个产品的更改，并且存在由于种种原因不使用Interface直接使用Service的情况，典型如图所示：</p>

<p><img src="http://7xogz7.com1.z0.glb.clouddn.com/domainandserviceinfection.png?imageMogr2/thumbnail/770x" alt="Domain传递和Service依赖" /></p>

<p>ABCD可能属于不同的产品，ACD可能需要不同版本的B的method1的实现，Class B也有可能需要修改，且各自的deadline并不相同。这就存在了B从version 1到version 2的修改过程中，其它产品夹带代码的问题。为了解决这个问题，服务拆分小组对现有代码进行了分析，发现现有代码存在几个问题：</p>

<ul>
  <li>Domain使用了Spring的ApplicationContext.getContext方式来获取Service实例。</li>
  <li>Service没有使用Interface，直接使用了实现类。</li>
  <li>产品A直接使用了产品B的domain来传递数据。</li>
</ul>

<p>为了解决这些问题，服务拆分小组重新设计了服务开发的规范：</p>

<ul>
  <li>Domain不允许使用Service，保持Domain的纯洁。</li>
  <li>对外提供服务的返回值采用基本数据类型或者定义VO类。</li>
  <li>对外提供的服务必须在实际调用的服务上再封装一层。</li>
  <li>调用其他产品的服务必须时必须封装一层，并实现自己的VO，避免对象污染。</li>
</ul>

<p>如图：</p>

<p><img src="http://7xogz7.com1.z0.glb.clouddn.com/improved.png?imageMogr2/thumbnail/770x" alt="什么鬼" /></p>

<p>这样解决了上面的问题，唯一的问题是结构更加复杂了。</p>

<h1 id="section">遗留问题</h1>
<p>分布式事务，老大难问题了。</p>


              <footer>
                <ul class="stats">
                
                  <li><a href="#">架构</a></li>
                
                  <li><a href="#">IoC</a></li>
                
        <!--
        <li><a href="#">General</a></li>
        <li><a href="#" class="icon fa-heart">28</a></li>
        <li><a href="#" class="icon fa-comment">128</a></li>
        -->
                </ul>
              </footer>
           </article>
  					<ul class="actions pagination">
  					  
  	  				  <li><a href="/%E6%9D%82%E9%A1%B9/2015/12/06/%E7%99%BB%E9%95%BF%E5%9F%8E%E8%AE%B0.html" class="button big previous">Previous Post</a></li>
  						
							
  						  <li><a href="/%E5%89%8D%E7%AB%AF/2015/12/20/%E7%BB%84%E4%BB%B6%E5%8C%96web%E5%BC%80%E5%8F%91%E5%92%8Cui%E8%AE%BE%E8%AE%A1%E8%90%BD%E5%9C%B0%E7%9A%84%E6%80%9D%E8%80%83.html" class="button big next">Next Post</a></li>
  						
  					</ul>
					</div>

				<!-- Sidebar -->
					<section id="sidebar">

						<!-- Intro -->
						<section id="intro">
  <a href="http://techctu.github.io/" class="logo"><img src="/images/logo.jpg" alt="" /></a>
	<header>
    <h2>Avalon</h2>
		<p>反正不要钱 多少写一点
    </p>
	</header>
</section>


						<!-- Mini Posts -->
						<section>
  <div class="mini-posts">
    
      <article class="mini-post">
  	    <header>
  		    <h3><a href="/2016/04/09/%E4%BD%BF%E7%94%A8reactjs%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85baidumap.html">使用ReactJS简单封装BaiduMap</a></h3>
		      <time class="published" datetime="2016-04-09">April 09, 2016</time>
						<!--<a href="#" class="author"><img src="/images/avatar.jpg" alt="" /></a>-->
			  </header>
        
		  </article>
									<!-- Mini Post -->
									  <!--
										<article class="mini-post">
											<header>
												<h3><a href="#">Vitae sed condimentum</a></h3>
												<time class="published" datetime="2015-10-20">October 20, 2015</time>
												<a href="#" class="author"><img src="/images/avatar.jpg" alt="" /></a>
											</header>
											<a href="#" class="image"><img src="/images/pic04.jpg" alt="" /></a>
										</article>
									-->
    
      <article class="mini-post">
  	    <header>
  		    <h3><a href="/2016/02/27/%E4%BD%BF%E7%94%A8reactjs%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E8%80%81%E8%99%8E%E6%9C%BA%E6%8A%BD%E5%A5%96%E7%BB%84%E4%BB%B6.html">使用ReactJS实现一个老虎机抽奖组件</a></h3>
		      <time class="published" datetime="2016-02-27">February 27, 2016</time>
						<!--<a href="#" class="author"><img src="/images/avatar.jpg" alt="" /></a>-->
			  </header>
        
		  </article>
									<!-- Mini Post -->
									  <!--
										<article class="mini-post">
											<header>
												<h3><a href="#">Vitae sed condimentum</a></h3>
												<time class="published" datetime="2015-10-20">October 20, 2015</time>
												<a href="#" class="author"><img src="/images/avatar.jpg" alt="" /></a>
											</header>
											<a href="#" class="image"><img src="/images/pic04.jpg" alt="" /></a>
										</article>
									-->
    
      <article class="mini-post">
  	    <header>
  		    <h3><a href="/%E5%89%8D%E7%AB%AF/2015/12/20/%E7%BB%84%E4%BB%B6%E5%8C%96web%E5%BC%80%E5%8F%91%E5%92%8Cui%E8%AE%BE%E8%AE%A1%E8%90%BD%E5%9C%B0%E7%9A%84%E6%80%9D%E8%80%83.html">组件化web开发和UI设计落地的思考</a></h3>
		      <time class="published" datetime="2015-12-20">December 20, 2015</time>
						<!--<a href="#" class="author"><img src="/images/avatar.jpg" alt="" /></a>-->
			  </header>
        
		  </article>
									<!-- Mini Post -->
									  <!--
										<article class="mini-post">
											<header>
												<h3><a href="#">Vitae sed condimentum</a></h3>
												<time class="published" datetime="2015-10-20">October 20, 2015</time>
												<a href="#" class="author"><img src="/images/avatar.jpg" alt="" /></a>
											</header>
											<a href="#" class="image"><img src="/images/pic04.jpg" alt="" /></a>
										</article>
									-->
    
      <article class="mini-post">
  	    <header>
  		    <h3><a href="/%E6%9E%B6%E6%9E%84/2015/12/11/java%E7%B3%BBdubbozookeeper%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E8%AE%B0%E5%BD%95.html">Java系Dubbo、Zookeeper系统服务拆分记录</a></h3>
		      <time class="published" datetime="2015-12-11">December 11, 2015</time>
						<!--<a href="#" class="author"><img src="/images/avatar.jpg" alt="" /></a>-->
			  </header>
        
		  </article>
									<!-- Mini Post -->
									  <!--
										<article class="mini-post">
											<header>
												<h3><a href="#">Vitae sed condimentum</a></h3>
												<time class="published" datetime="2015-10-20">October 20, 2015</time>
												<a href="#" class="author"><img src="/images/avatar.jpg" alt="" /></a>
											</header>
											<a href="#" class="image"><img src="/images/pic04.jpg" alt="" /></a>
										</article>
									-->
    
  </div>
</section>


						<!-- Posts List -->

						<!-- About -->
					  <section class="blurb">
	<p>抱朴 守拙
</p>
</section>


						<!-- Footer -->
						<section id="footer">
  <ul class="icons">
		<li><a href="https://github.com/techctu" class="fa-github"><span class="label">GitHub</span></a></li>
		<li><a href="/feed.xml" class="fa-rss"><span class="label">RSS</span></a></li>
		<li><a href="mailto:unlitechc@yahoo.com" class="fa-envelope"><span class="label">Email</span></a></li>
	</ul>
  <p class="copyright">Copyright &copy; 2015 techctu</p>
</section>

					</section>
			</div>
		<!-- Scripts -->
		<script src="/js/jquery.min.js"></script>
<script src="/js/skel.min.js"></script>
<script src="/js/util.js"></script>
<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
<script src="/js/main.js"></script>

	</body>
</html>
