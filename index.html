<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="中年危机攻城狮的小圆子，Java，JavaScript，Spring，ReactJS，摄影，一些小东西。">
<meta name="keywords" content="Java,JavaScript,ReactJS,Spring,摄影">
<meta property="og:type" content="website">
<meta property="og:title" content="Avalon">
<meta property="og:url" content="https://zhaozeyu.space/index.html">
<meta property="og:site_name" content="Avalon">
<meta property="og:description" content="中年危机攻城狮的小圆子，Java，JavaScript，Spring，ReactJS，摄影，一些小东西。">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Avalon">
<meta name="twitter:description" content="中年危机攻城狮的小圆子，Java，JavaScript，Spring，ReactJS，摄影，一些小东西。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhaozeyu.space/"/>





  <title>Avalon</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Avalon</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">域名要收费，多少写一点</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhaozeyu.space/2017/02/24/webpack-2-和-react-router-实现按需加载/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zeyu Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Avalon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/24/webpack-2-和-react-router-实现按需加载/" itemprop="url">webpack 2 和 react-router 实现按需加载</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-24T00:00:00+08:00">
                2017-02-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>产品上线了一段时日，偷偷摸摸把 webpack 升级到了 2.x ，出现了很多优化需求，意味着很多新的库、新的代码，以及，更大的 bundle 。怎么办呢？ Code Splitting 呗！按需加载、懒加载┏ (゜ω゜)=☞。</p>
<h1 id="Code-Splitting-的方式"><a href="#Code-Splitting-的方式" class="headerlink" title="Code Splitting 的方式"></a>Code Splitting 的方式</h1><p>前端代码一般需要进行拆分的地方有：</p>
<ul>
<li>公共代码拆分，如所有代码共用的三方库，某些业务模块或页面用的三方库。</li>
<li>特定业务场景加速，如首页，或者多页面入口时的入口页面加速。比如现在老板要你做个地理位置的AR，总不能直接把这个包和常规业务代码丢一块加载吧。</li>
</ul>
<h1 id="babel-、-webpack-依赖配置"><a href="#babel-、-webpack-依赖配置" class="headerlink" title="babel 、 webpack 依赖配置"></a>babel 、 webpack 依赖配置</h1><p>很多人都说 ES6 、 ES7 会毁了 JavaScript ，但各大语言语法趋向一致不是大趋势吗？难道之前的人开发写了一堆 polyfill 来解决各种诡异的问题后纷纷走向高级岗位，还要像吹牛逼说自己拿记事本写上万行代码一样，要求后来者也会写这堆 polyfill 吗？使用成熟的工具，是团队成功的必要条件之一吧。新的版本的曙光已经到来，不必抱残守缺。</p>
<h2 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h2><p>这里使用的 webpack 为 2.2.1 。按照 <a href="https://webpack.js.org/guides/code-splitting/" target="_blank" rel="noopener">webpack 官网文档</a>，需要先安装 babel 相关插件。</p>
<figure class="highlight mipsasm"><figcaption><span>lang: js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install </span>--save-dev <span class="keyword">babel-core </span><span class="keyword">babel-loader </span><span class="keyword">babel-plugin-syntax-dynamic-import </span><span class="keyword">babel-preset-es2015</span></span><br></pre></td></tr></table></figure>
<p>然后在 <code>.babelrc</code> 里，或是在 <code>package.json</code> 的 <code>&quot;babel&quot;</code> 里，亦或在 <code>webpack.config</code> 的 <code>module -&gt; rules -&gt; use -&gt; loader: &#39;babel-loader&#39;</code> 的同级下配置。这里我是在 <code>package.json</code> 里配置。</p>
<figure class="highlight json"><figcaption><span>lang: json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"babel"</span>: &#123;</span><br><span class="line">    <span class="attr">"presets"</span>: [<span class="string">"es2015"</span>],</span><br><span class="line">    <span class="attr">"plugins"</span>: [<span class="string">"syntax-dynamic-import"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就可以这样写代码。</p>
<figure class="highlight javascript"><figcaption><span>lang: js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">determineDate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">import</span>(<span class="string">'moment'</span>)</span><br><span class="line">    .then(<span class="function"><span class="params">moment</span> =&gt;</span> moment().format(<span class="string">'LLLL'</span>))</span><br><span class="line">    .then(<span class="function"><span class="params">str</span> =&gt;</span> <span class="built_in">console</span>.log(str))</span><br><span class="line">    .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'Failed to load moment'</span>, err));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">determineDate();</span><br></pre></td></tr></table></figure>
<p>目前这样已经可以使用 webpack 和 babel 来进行代码拆分了。</p>
<h2 id="尝鲜配置"><a href="#尝鲜配置" class="headerlink" title="尝鲜配置"></a>尝鲜配置</h2><p>目前 ES7 的 async/await 语法都要出来了，只配置这些怎么够？所以我这样配置。</p>
<figure class="highlight mipsasm"><figcaption><span>lang: js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install </span>--save-dev <span class="keyword">babel-preset-es2015 </span><span class="keyword">babel-preset-es2016 </span><span class="keyword">babel-preset-2017 </span><span class="keyword">babel-preset-stage-0 </span><span class="keyword">babel-plugin-transform-decorators </span><span class="keyword">babel-plugin-transform-decorators-legacy </span><span class="keyword">babel-plugin-transform-object-rest-spread </span><span class="keyword">babel-preset-react</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><figcaption><span>lang: json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"babel"</span>: &#123;</span><br><span class="line">    <span class="attr">"presets"</span>: [<span class="string">"es2015"</span>,<span class="string">"es2016"</span>,<span class="string">"es2017"</span>,<span class="string">"stage-0"</span>,<span class="string">"react"</span>],</span><br><span class="line">    <span class="attr">"plugins"</span>: [<span class="string">"syntax-dynamic-import"</span>,<span class="string">"transform-decorators-legacy"</span>,<span class="string">"transform-object-rest-spread"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就可以用各种新特性，比如箭头函数、async/await、装饰器等。</p>
<h1 id="基于-react-router-的代码拆分"><a href="#基于-react-router-的代码拆分" class="headerlink" title="基于 react-router 的代码拆分"></a>基于 react-router 的代码拆分</h1><p>在 <a href="https://github.com/ReactTraining/react-router/tree/master/examples/huge-apps" target="_blank" rel="noopener">react-router的示例代码 huge-apps</a> 里有非常经典的基于路由的代码拆分方案。</p>
<blockquote>
<p>为什么基于路由拆分？一般一个路由对应一个逻辑上的业务页面，而一般多个业务页面在一个子路由下构成了业务流程，其代码依赖也比较相近，适合做代码拆分。</p>
</blockquote>
<h2 id="基础路由配置"><a href="#基础路由配置" class="headerlink" title="基础路由配置"></a>基础路由配置</h2><p>不拆分的路由长 <a href="https://github.com/ReactTraining/react-router/blob/master/docs/guides/RouteConfiguration.md" target="_blank" rel="noopener">这样</a> 。</p>
<figure class="highlight xml"><figcaption><span>lang: html</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Router</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">"/"</span> <span class="attr">component</span>=<span class="string">&#123;App&#125;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">"about"</span> <span class="attr">component</span>=<span class="string">&#123;About&#125;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">"inbox"</span> <span class="attr">component</span>=<span class="string">&#123;Inbox&#125;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">"messages/:id"</span> <span class="attr">component</span>=<span class="string">&#123;Message&#125;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Router</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>或者 <a href="https://github.com/ReactTraining/react-router/blob/master/docs/guides/RouteConfiguration.md" target="_blank" rel="noopener">这样</a> 。</p>
<figure class="highlight yaml"><figcaption><span>lang: js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">const</span> <span class="string">routes</span> <span class="string">=</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">'/'</span><span class="string">,</span></span><br><span class="line"><span class="attr">  component:</span> <span class="string">App,</span></span><br><span class="line"><span class="attr">  indexRoute:</span> <span class="string">&#123;</span> <span class="attr">component:</span> <span class="string">Dashboard</span> <span class="string">&#125;,</span></span><br><span class="line"><span class="attr">  childRoutes:</span> <span class="string">[</span></span><br><span class="line">    <span class="string">&#123;</span> <span class="attr">path:</span> <span class="string">'about'</span><span class="string">,</span> <span class="attr">component:</span> <span class="string">About</span> <span class="string">&#125;,</span></span><br><span class="line">    <span class="string">&#123;</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">'inbox'</span><span class="string">,</span></span><br><span class="line"><span class="attr">      component:</span> <span class="string">Inbox,</span></span><br><span class="line"><span class="attr">      childRoutes:</span> <span class="string">[&#123;</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">'messages/:id'</span><span class="string">,</span></span><br><span class="line"><span class="attr">        onEnter:</span> <span class="string">(&#123;</span> <span class="string">params</span> <span class="string">&#125;,</span> <span class="string">replace)</span> <span class="string">=&gt;</span> <span class="string">replace(`/messages/$&#123;params.id&#125;`)</span></span><br><span class="line">      <span class="string">&#125;]</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="string">&#123;</span></span><br><span class="line"><span class="attr">      component:</span> <span class="string">Inbox,</span></span><br><span class="line"><span class="attr">      childRoutes:</span> <span class="string">[&#123;</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">'messages/:id'</span><span class="string">,</span> <span class="attr">component:</span> <span class="string">Message</span></span><br><span class="line">      <span class="string">&#125;]</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="string">]</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>然后，构建时 webpack 就会把所以依赖静态分析后打到指定的 bundle 里。</p>
<h2 id="路由拆分配置"><a href="#路由拆分配置" class="headerlink" title="路由拆分配置"></a>路由拆分配置</h2><p>react-router 利用 webpack 支持的 <code>require.ensure</code> 来实现延迟加载。基本思路是将需要拆分的路由注册到路由配置里，将依赖的 react 组件通过 require.ensure 来加载，听过 getChildRoutes 和 getComponents 这样的黑科技。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 组件和其路由</span></span><br><span class="line"><span class="comment">// Announcement/Announcement.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Announcement</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; courseId, announcementId &#125; = <span class="keyword">this</span>.props.params</span><br><span class="line">    <span class="keyword">let</span> &#123; title, body &#125; = COURSES[courseId].announcements[announcementId]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h4&gt;&#123;title&#125;&lt;<span class="regexp">/h4&gt;</span></span><br><span class="line"><span class="regexp">        &lt;p&gt;&#123;body&#125;&lt;/</span>p&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">module.exports = Announcement</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 对应路由封装和暴露</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ Announcement/i</span>ndex.js</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  path: <span class="string">':announcementId'</span>,</span><br><span class="line"></span><br><span class="line">  getComponent(location, cb) &#123;</span><br><span class="line">    <span class="built_in">require</span>.ensure([], (<span class="built_in">require</span>) =&gt; &#123;</span><br><span class="line">      cb(<span class="literal">null</span>, <span class="built_in">require</span>(<span class="string">'./components/Announcement'</span>))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由配置</span></span><br><span class="line"><span class="keyword">const</span> rootRoute = &#123;</span><br><span class="line">  component: <span class="string">'div'</span>,</span><br><span class="line">  childRoutes: [ &#123;</span><br><span class="line">    path: <span class="string">'/'</span>,</span><br><span class="line">    component: <span class="built_in">require</span>(<span class="string">'./components/App'</span>),</span><br><span class="line">    childRoutes: [</span><br><span class="line">      <span class="built_in">require</span>(<span class="string">'./routes/Announcement'</span>)</span><br><span class="line">    ]</span><br><span class="line">  &#125; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单来说，就是</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">const rootRoute = &#123;</span><br><span class="line">  component: <span class="string">'div'</span>,</span><br><span class="line">  childRoutes: [ &#123;</span><br><span class="line">    path: <span class="string">'/'</span>,</span><br><span class="line">    component: <span class="built_in">require</span>(<span class="string">'./components/App'</span>),</span><br><span class="line">    childRoutes: [</span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">':announcementId'</span>,</span><br><span class="line"></span><br><span class="line">        getComponent(location, cb) &#123;</span><br><span class="line">          <span class="built_in">require</span>.ensure([], <span class="function"><span class="params">(<span class="built_in">require</span>)</span> =&gt;</span> &#123;</span><br><span class="line">            cb(<span class="literal">null</span>, <span class="built_in">require</span>(<span class="string">'./components/Announcement'</span>))</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="webpack-2-x-下的加载方式"><a href="#webpack-2-x-下的加载方式" class="headerlink" title="webpack 2.x 下的加载方式"></a>webpack 2.x 下的加载方式</h2><p>上面是 webpack 1.x 的配置方式，而在 2.x 下，需要进行一些修改，主要是用 <code>import</code> 替换 <code>require.ensure</code> 。</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span> Announcement/index.js</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  path: <span class="string">':announcementId'</span>,</span><br><span class="line"></span><br><span class="line">  getComponent(location, cb) &#123;</span><br><span class="line">    <span class="keyword">import</span>(<span class="string">'./components/Announcement'</span>)</span><br><span class="line">      .<span class="keyword">then</span>(<span class="function"><span class="params">(<span class="built_in">module</span>)</span>=&gt;</span>&#123;cb(<span class="literal">null</span>, <span class="built_in">module</span>.<span class="keyword">default</span>);&#125;)</span><br><span class="line">      .<span class="keyword">catch</span>(<span class="function"><span class="params">(err)</span>=&gt;</span>&#123;<span class="built_in">console</span>.log(err)&#125;);</span><br><span class="line">    <span class="regexp">//</span> <span class="built_in">require</span>.ensure([], <span class="function"><span class="params">(<span class="built_in">require</span>)</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="regexp">//</span>   cb(<span class="literal">null</span>, <span class="built_in">require</span>(<span class="string">'./components/Announcement'</span>))</span><br><span class="line">    <span class="regexp">//</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="TODOs"><a href="#TODOs" class="headerlink" title="TODOs"></a>TODOs</h1><ul>
<li>懒加载划分和加载异常处理。</li>
<li>合适的目录结构划分。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhaozeyu.space/2017/02/18/使用-nodejs-zip--tar-目录--文件夹/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zeyu Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Avalon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/18/使用-nodejs-zip--tar-目录--文件夹/" itemprop="url">使用 nodejs zip / tar 目录 / 文件夹</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-18T00:00:00+08:00">
                2017-02-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>有某个大佬想要搞自动发布，问我能不能搞一个 zip 静态资源目录的脚本。我瞅了瞅他，看在 windows 环境的面子上，就没有要求他自己写 shell 脚本了。</p>
<h1 id="去-npm-找一个库"><a href="#去-npm-找一个库" class="headerlink" title="去 npm 找一个库"></a>去 npm 找一个库</h1><p>万能的 npm 上有个 <a href="https://www.npmjs.com/package/archiver" target="_blank" rel="noopener">archiver</a> ，正好可以打包目录，和那些只能 appendFile 的妖艳贱货都不一样呢。</p>
<h1 id="写打包脚本"><a href="#写打包脚本" class="headerlink" title="写打包脚本"></a>写打包脚本</h1><blockquote>
<p>你会写nodejs吗？<br>我也不知道什么算会写啊，写个这个脚本打包个目录算不算？</p>
</blockquote>
<p>直接上代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span>;</span><br><span class="line"><span class="keyword">import</span> archiver <span class="keyword">from</span> <span class="string">'archiver'</span>;</span><br><span class="line"><span class="keyword">import</span> moment <span class="keyword">from</span> <span class="string">'moment'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 nodejs 封装的接口检查是否存在输出目录</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkOutputDir</span>(<span class="params">dest=<span class="string">'archiver/'</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// nodejs版本更新后将fs.R_OK挪到了fs.constants.R_OK</span></span><br><span class="line">    <span class="keyword">const</span> R_OK = fs.R_OK || fs.constants.R_OK;</span><br><span class="line">    <span class="keyword">const</span> W_OK = fs.W_OK || fs.constants.W_OK;</span><br><span class="line"></span><br><span class="line">    fs.access(dest, R_OK | W_OK , (err)=&gt;&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'try to create archiver directory'</span>);</span><br><span class="line">        fs.mkdir(dest, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="built_in">console</span>.error(<span class="string">'fail: create archiver directory'</span>);</span><br><span class="line">            reject(err);</span><br><span class="line">          &#125;</span><br><span class="line">          resolve();</span><br><span class="line">        &#125;);</span><br><span class="line">        resolve();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`can read and write <span class="subst">$&#123;dest&#125;</span>`</span>);</span><br><span class="line">        resolve();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 压缩资源</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">zip</span>(<span class="params">targetEnv=<span class="string">'production'</span>, src=<span class="string">'asset/'</span>, dest=<span class="string">'archiver/'</span>, project=<span class="string">'projName'</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> checkOutputDir();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> file = <span class="string">`<span class="subst">$&#123;dest&#125;</span><span class="subst">$&#123;project&#125;</span>-<span class="subst">$&#123;targetEnv&#125;</span>-<span class="subst">$&#123;moment().format(<span class="string">'YYYYMMDD-HHmmss'</span>)&#125;</span>.zip`</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`prepare to create zipped file: <span class="subst">$&#123;file&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">let</span> archive = archiver(<span class="string">'zip'</span>, &#123;<span class="attr">zlib</span>:&#123;<span class="attr">level</span>: <span class="number">9</span>&#125;&#125;);</span><br><span class="line">    <span class="keyword">let</span> out = fs.createWriteStream(file);</span><br><span class="line">    out.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(archive.pointer() + <span class="string">' total bytes'</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'archiver finalized'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    archive.on(<span class="string">'error'</span>, (err)=&gt;&#123;reject(err);&#125;);</span><br><span class="line"></span><br><span class="line">    archive.directory(src);</span><br><span class="line"></span><br><span class="line">    archive.pipe(out);</span><br><span class="line">    archive.finalize();</span><br><span class="line">    resolve();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> zip;</span><br></pre></td></tr></table></figure>
<h1 id="TODOs"><a href="#TODOs" class="headerlink" title="TODOs"></a>TODOs</h1><p>干脆用command整个命令得了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhaozeyu.space/2017/02/18/从-webpack-1x-迁移到-webpack-2x/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zeyu Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Avalon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/18/从-webpack-1x-迁移到-webpack-2x/" itemprop="url">从 webpack 1.x 迁移到 webpack 2.x</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-18T00:00:00+08:00">
                2017-02-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>项目搭建使用的 webpack 1.3.1 来作为打包工具，webpack 2.2 已经发布。</p>
<h1 id="升级项目依赖"><a href="#升级项目依赖" class="headerlink" title="升级项目依赖"></a>升级项目依赖</h1><p>备份，在 <figure class="highlight plain"><figcaption><span>中移除 ```webpack``` 依赖。使用了 ```extract-text-webpack-plugin``` 的话这个插件也需要更新。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 修改 webpack.config （开发）</span><br><span class="line"></span><br><span class="line">## debug</span><br><span class="line"></span><br><span class="line">1.x 中使用了 ```debug:true``` 的配置，在 2.x 中改为：</span><br></pre></td></tr></table></figure></p>
<p>plugins: [<br>    new webpack.LoaderOptionsPlugin({debug: true})<br>  ]<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## resolve</span><br><span class="line">resolve.extensions 不再需要传入空字符串，`extensions: [<span class="string">''</span>, <span class="string">'js'</span>]` -&gt; `extensions: [<span class="string">'js'</span>]`。</span><br><span class="line"></span><br><span class="line">增加 modules 配置来加速加载 `modules: [path.resolve(__dirname, <span class="string">'./scripts'</span>), <span class="string">'node_modules'</span>]` 。</span><br><span class="line"></span><br><span class="line">## proxy</span><br><span class="line">因为动静分离，<span class="number">1.</span>x 中使用了 ```proxy:&#123;<span class="string">'/uri/*'</span>:&#123;target:<span class="string">'https://host'</span>&#125;&#125;``` 来进行代理。在 <span class="number">2.</span>x 中将这部分配置挪到了启动 webpack-dev-server 的脚本中：</span><br><span class="line"></span><br><span class="line">&#123;% codeblock lang: js %&#125;</span><br><span class="line">new WebpackDevServer(bundler, &#123;</span><br><span class="line">    proxy: &#123;</span><br><span class="line">        <span class="string">'/yh-web/*'</span>: &#123;</span><br><span class="line">          <span class="comment">//target: 'http://localhost:9080'</span></span><br><span class="line">          target: <span class="string">'http://10.230.146.19:9080'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">'/yx-web/*'</span>: &#123;</span><br><span class="line">          target: <span class="string">'http://localhost:9090'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#123;% endcodeblock %&#125;</span><br><span class="line"></span><br><span class="line">## NoErrorsPlugin</span><br><span class="line">废弃，使用 ```NoEmitOnErrorsPlugin``` 。</span><br><span class="line"></span><br><span class="line">## <span class="keyword">module</span></span><br><span class="line">```<span class="keyword">module</span>.loaders``` 修改为 ```<span class="keyword">module</span>.rules``` 。</span><br><span class="line"></span><br><span class="line">Loaders 需要添加 `-loader`，如 `babel` -&gt; `babel-loader` 。</span><br><span class="line"></span><br><span class="line"># 修改生产配置 webpack.config.production.js</span><br><span class="line">除了上述修改，目前主要为 extract-text-webpack-plugin 的配置修改。</span><br><span class="line"></span><br><span class="line">## extract-text-webpack-plugin</span><br><span class="line">- Plugin 中的参数 `new ExtractTextPlugin(<span class="string">'css/[name].[chunkhash].css'</span>, &#123;allChunks: true&#125;)` 修改为 `new ExtractTextPlugin(&#123;filename: <span class="string">'css/[name].[chunkhash].css'</span>, allChunks: true&#125;`</span><br><span class="line">- rules 中 css 抽取修改为 `use: ExtractTextPlugin.extract(&#123;fallback: <span class="string">'style-loader'</span>, use: <span class="string">'css-loader?modules&amp;minimize&amp;importLoaders=1&amp;localIdentName=[hash:base64:5]'</span>&#125;)`</span><br><span class="line"></span><br><span class="line">## OccurenceOrderPlugin 和 DedupePlugin</span><br><span class="line">废弃，webpack <span class="number">2.</span>x 自带，不再使用。</span><br><span class="line"></span><br><span class="line">## UglifyJsPlugin</span><br><span class="line">[官方默认配置](https:<span class="comment">//webpack.js.org/guides/migrating/#uglifyjsplugin-sourcemap)已修改，这里配置改为</span></span><br></pre></td></tr></table></figure></p>
<p>new webpack.optimize.UglifyJsPlugin({<br>  compress: {warnings: false},<br>  souceMap: false,<br>  minimize: true<br>})<br><code>`</code></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://webpack.js.org/guides/migrating/" target="_blank" rel="noopener">Migrating from v1 to v2</a></p>
<p><a href="http://www.zcfy.cc/article/migrating-from-v1-to-v2-2378.html" target="_blank" rel="noopener">从 webpack v1 迁移到 webpack v2</a></p>
<p><a href="http://imweb.io/topic/5868e1abb3ce6d8e3f9f99bb" target="_blank" rel="noopener">webpack 2终极优化</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhaozeyu.space/2017/02/18/在-html-中使用-react-和-jsx--不使用-nodejs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zeyu Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Avalon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/18/在-html-中使用-react-和-jsx--不使用-nodejs/" itemprop="url">在 html 中使用 react 和 jsx —— 不使用 nodejs</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-18T00:00:00+08:00">
                2017-02-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天有人跟我提了一个非常奇怪的需求：想使用 reactjs 来组件化，重写以前封装的组件。但他们的 leader 又觉得 node 、 npm 、 webpack 那一套很麻烦，太复杂了，只想要 react 封装组件。所以他想要的可能是这样：</p>
<ul>
<li>组件封装在 js 里，使用 react 封装。</li>
<li>访问某个页面时，返回对应的 html 文件，文件中引入 js ，非 SPA 。</li>
<li>绝对不使用 node 、 npm 、 webpack 。</li>
</ul>
<h1 id="在-html-中使用-react"><a href="#在-html-中使用-react" class="headerlink" title="在 html 中使用 react"></a>在 html 中使用 react</h1><p>可以参考 <a href="https://www.sitepoint.com/getting-started-react-jsx/" target="_blank" rel="noopener">Getting Started with React</a>  （<em>不能访问请翻墙</em>）。</p>
<h2 id="开始使用-react"><a href="#开始使用-react" class="headerlink" title="开始使用 react"></a>开始使用 react</h2><p>去国内 CDN 去找到 react 、 react-dom 、 browser 三个库，如 <a href="http://www.bootcdn.cn/" target="_blank" rel="noopener">BootCDN</a> 。</p>
<p>参考一下官网的 <a href="https://facebook.github.io/react/docs/hello-world.html" target="_blank" rel="noopener">hello-world</a> 。</p>
<p>找个地方创建目录，写一个 <code>index.html</code> 。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh-cmn-Hans"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>My First React Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"greeting-div"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://cdn.bootcss.com/react/15.4.2/react.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://cdn.bootcss.com/react/15.4.2/react-dom.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://cdn.bootcss.com/babel-core/6.1.19/browser.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/babel"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="actionscript">      <span class="keyword">var</span> Greeting = React.createClass(&#123;</span></span><br><span class="line"><span class="actionscript">        render: <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">          <span class="keyword">return</span> (</span></span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello, Universe<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span></span><br><span class="line"><span class="undefined">          )</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">      &#125;);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">      ReactDOM.render(</span></span><br><span class="line"><span class="handlebars"><span class="xml">        <span class="tag">&lt;<span class="name">Greeting</span>/&gt;</span>,</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.getElementById(<span class="string">'greeting-div'</span>)</span></span><br><span class="line"><span class="undefined">      );</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这段代码创建了一个名为 <code>Greeting</code> 的 <code>react</code> 组件，然后在 <code>greeting-div</code> 这个 <code>div</code> 下使用 <code>react-dom</code> 的 <code>render</code> 方法来渲染成如下代码：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"greeting-div"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello, Universe<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><em>原文其他部分不再翻译，毕竟这篇文章不是为了翻译，只是记录一下怎么在浏览器中使用 react 。语法部分的问题参考其他文章即可</em></p>
<h2 id="与使用-webpack-等的区别"><a href="#与使用-webpack-等的区别" class="headerlink" title="与使用 webpack 等的区别"></a>与使用 webpack 等的区别</h2><p>在一般的开发过程中，使用的是 node + npm + webpack + babel + react + react-dom ， 可能还要使用 redux 系列的库来开发，项目多为 SPA 。从开发到浏览器访问的处理过程一般为：</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">react</span> <span class="comment">组件/页面（</span> <span class="comment">es6</span> <span class="comment">语法）</span><span class="literal">-</span><span class="literal">-</span><span class="comment">（</span> <span class="comment">webpack</span> <span class="comment">、</span> <span class="comment">babel</span> <span class="comment">）</span><span class="literal">-</span><span class="literal">-</span>&gt; <span class="comment">es5</span> <span class="comment">语法的</span> <span class="comment">js</span> <span class="comment">chunk</span></span><br></pre></td></tr></table></figure>
<p>如果不使用这些，辣么就得在浏览器中通过 <code>browser.js</code> 来将 es6 的语法转换成 es5 。</p>
<p><strong>这样做很有可能会降低页面渲染速度。</strong></p>
<h2 id="对最终目录结构的猜想"><a href="#对最终目录结构的猜想" class="headerlink" title="对最终目录结构的猜想"></a>对最终目录结构的猜想</h2><p>可能是类似这样：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/</span><br><span class="line">|<span class="string">__view</span></span><br><span class="line">|<span class="string">   </span>|__home</span><br><span class="line">|<span class="string">   </span>|<span class="string">   </span>|<span class="string">__index.html // 页面入口html</span></span><br><span class="line">|<span class="string">   </span>|<span class="string">   </span>|<span class="string">__index.js  // 页面入口js</span></span><br><span class="line">|<span class="string">   </span>|<span class="string">   </span>|<span class="string">__ComA.js  // 页面使用的组件</span></span><br><span class="line">|__common</span><br><span class="line">|<span class="string">__</span>|__header</span><br><span class="line">|<span class="string">__</span>|<span class="string">__footer // 在这里的 html 模板片段中引入 react 、 react-dom 和 browser</span></span><br><span class="line">|<span class="string">__css // 可能 css 就是一个文件</span></span><br><span class="line">|__image</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhaozeyu.space/2017/02/04/停止更新使用issues来记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zeyu Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Avalon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/04/停止更新使用issues来记录/" itemprop="url">停止更新，使用issues来记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-04T00:00:00+08:00">
                2017-02-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最后一篇，以后使用 <a href="https://github.com/techctu/techctu.github.io/issues" target="_blank" rel="noopener">issues</a> 来记录。</p>
<p>有空了再挑挑文章来迁移。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhaozeyu.space/2017/01/11/使用gsap简单实现react列表中的下拉刷新和上拉加载更多/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zeyu Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Avalon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/11/使用gsap简单实现react列表中的下拉刷新和上拉加载更多/" itemprop="url">使用GSAP简单实现react列表中的下拉刷新和上拉加载更多</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-11T00:00:00+08:00">
                2017-01-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>项目上线后看着列表不能下拉刷新不能上拉加载非常不爽，就做了个简单的实现。</p>
<p><em>为什么自己造轮子？用react不想添加jQuery，同时GitHub上的大部分代码都不能同时支持上拉和下拉。</em></p>
<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><p>找个现成的项目新建一个页面，写个timeout模拟异步请求。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">refresh() &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;<span class="keyword">this</span>.setState(&#123;</span><br><span class="line">    items: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">  &#125;)&#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">loadMore() &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span>=&gt;</span>&#123;<span class="keyword">this</span>.setState(&#123;</span><br><span class="line">    items: <span class="keyword">this</span>.state.items.concat([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>])</span><br><span class="line">  &#125;)&#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再整个生成列表。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderList</span>(<span class="params">list</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">list.map((v, i</span>) =&gt;</span> (</span><br><span class="line">    &lt;li key=&#123;i&#125; onClick=&#123;<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;browserHistory.push(<span class="string">'/MerchantDetail/'</span> + v.id + <span class="string">'/'</span> + v.distance);&#125;&#125;&gt;</span><br><span class="line">      &lt;div styleName=<span class="string">"m-shop-right"</span>&gt;</span><br><span class="line">        &lt;h1&gt;</span><br><span class="line">          &#123;i&#125;</span><br><span class="line">        &lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    &lt;<span class="regexp">/li&gt;)</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>然后开始搞事情。</p>
<h1 id="实现下拉和上拉"><a href="#实现下拉和上拉" class="headerlink" title="实现下拉和上拉"></a>实现下拉和上拉</h1><h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p>现在的上拉和下拉大部分是：</p>
<ol>
<li>监听ontouchstart, ontouchmove, ontouchend三个事件。</li>
<li>判断上拉下拉边界，进行对应的CSS transform和transition。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sample，监听list的事件，修改list-header</span></span><br><span class="line">&lt;div id=<span class="string">"list"</span>&gt;</span><br><span class="line">    &lt;div id=<span class="string">"list-header"</span> /&gt;</span><br><span class="line">    &lt;div id=<span class="string">"list-items"</span> /&gt;</span><br><span class="line">&lt;<span class="regexp">/div&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>最开始想用 <code>react-css-transition-group</code> 或 <code>react-transition-group</code> 来实现上拉和下拉效果，像这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;reactcsstransitiongroup ref=&#123;(el) =&gt; <span class="keyword">this</span>._ref = el&#125;&gt;</span><br><span class="line">    &lt;div id=<span class="string">"list-header"</span> /&gt;</span><br><span class="line">    &lt;div id=<span class="string">"list-items"</span> /&gt;</span><br><span class="line">&lt;<span class="regexp">/reactcsstransitiongroup&gt;</span></span><br></pre></td></tr></table></figure>
<p>然而仔细阅读了之后，发现只能在 <code>mount</code> 和 <code>unmount</code> 这两个关键点触发动画，在 <code>update</code> 的时候无法触发。</p>
<p>我非常不希望通过 <figure class="highlight plain"><figcaption><span>style</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">这个就非常微妙了，既然如此，我为何一定要用 `react-css-transition-group` 或 `react-transition-group` 呢？简单点不好么？直接把这部分动画操作放在直接的DOM操作里绕开react，然后在ontouchend里回调，也是一种不错的思路。</span><br><span class="line"></span><br><span class="line">```js</span><br><span class="line">&lt;div id=&quot;g-wrap&quot; onTouchStart=&#123;(e) =&gt; this.handleTouchStart(e)&#125;</span><br><span class="line">  onTouchMove=&#123;(e) =&gt; this.handleTouchMove(e)&#125;</span><br><span class="line">  onTouchEnd=&#123;(e) =&gt; this.handleTouchEnd(e)&#125;&gt;</span><br><span class="line">    // ...</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">handleTouchStart(e) &#123;</span><br><span class="line">  <span class="keyword">this</span>._touchStartPosY = e.touches[<span class="number">0</span>].pageY;<span class="comment">//记录触摸开始位置</span></span><br><span class="line">  <span class="keyword">this</span>._gmainDefaultPaddingTopRem = <span class="string">'1.8rem'</span>;<span class="comment">//记录初始列表头部位置，可改成接收参数</span></span><br><span class="line">  <span class="keyword">this</span>._gmainDefaultPaddingTop = <span class="built_in">parseInt</span>(</span><br><span class="line">    <span class="keyword">this</span>._gmainDefaultPaddingTopRem.substr(<span class="number">0</span>, <span class="keyword">this</span>._gmainDefaultPaddingTopRem.length - <span class="number">3</span>));</span><br><span class="line">  <span class="keyword">this</span>._gmainDefaultPaddingBottom = <span class="number">0</span>;<span class="comment">//底部</span></span><br><span class="line">  <span class="keyword">this</span>._lastScrollY = <span class="number">-1</span>;<span class="comment">//用于记录上一次滚动位置</span></span><br><span class="line">  <span class="keyword">this</span>._equalScroll = <span class="literal">false</span>;<span class="comment">//用于标记上拉到了底部</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">handleTouchMove(e) &#123;</span><br><span class="line">  <span class="keyword">this</span>._touchEndPosY = e.touches[<span class="number">0</span>].pageY;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 下拉到顶</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.scrollY &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>._lastScrollY = <span class="built_in">window</span>.scrollY;</span><br><span class="line">    <span class="comment">// 拉且限制拉的距离</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._touchEndPosY - <span class="keyword">this</span>._touchStartPosY &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>._touchEndPosY - <span class="keyword">this</span>._touchStartPosY &lt; <span class="number">100</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> gmain = findDOMNode(<span class="keyword">this</span>._gmain);</span><br><span class="line">      <span class="comment">// 偷懒使用TweenMax来生成动画</span></span><br><span class="line">      TweenMax.to(gmain, <span class="number">0</span>,</span><br><span class="line">        &#123;<span class="attr">paddingTop</span>: <span class="keyword">this</span>._gmainDefaultPaddingTop +</span><br><span class="line">            (<span class="keyword">this</span>._touchEndPosY - <span class="keyword">this</span>._touchStartPosY)/<span class="number">20</span> + <span class="string">'rem'</span>,</span><br><span class="line">            ease: Power0.easeInOut&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 上拉到底</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.scrollY == <span class="keyword">this</span>._lastScrollY) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>._equalScroll) &#123;</span><br><span class="line">        <span class="keyword">this</span>._equalScroll = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">this</span>._equalScrollY = <span class="built_in">window</span>.scrollY;</span><br><span class="line">        <span class="keyword">this</span>._equalClientY = e.touches[<span class="number">0</span>].clientY;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> gmain = findDOMNode(<span class="keyword">this</span>._gmain);</span><br><span class="line">      e.preventDefault();</span><br><span class="line">      <span class="comment">// 限制上拉距离生成动画</span></span><br><span class="line">      <span class="keyword">let</span> offsetY = <span class="keyword">this</span>._touchEndPosY&gt;<span class="number">100</span>?<span class="number">100</span>:<span class="keyword">this</span>._touchEndPosY;</span><br><span class="line">      TweenMax.to(gmain, <span class="number">0</span>,</span><br><span class="line">        &#123;<span class="attr">paddingBottom</span>: <span class="keyword">this</span>._gmainDefaultPaddingBottom + offsetY/<span class="number">20</span>&gt; + <span class="string">'rem'</span>,</span><br><span class="line">        ease: Power0.easeInOut&#125;);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>._lastScrollY = <span class="built_in">window</span>.scrollY;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">handleTouchEnd(e) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.scrollY &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._touchEndPosY - <span class="keyword">this</span>._touchStartPosY &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> gmain = findDOMNode(<span class="keyword">this</span>._gmain);</span><br><span class="line">      <span class="comment">// 弹回</span></span><br><span class="line">      TweenMax.to(gmain, <span class="number">1</span>,</span><br><span class="line">        &#123;<span class="attr">paddingTop</span>: <span class="keyword">this</span>._gmainDefaultPaddingTopRem,</span><br><span class="line">            ease: Back.easeInOut&#125;);</span><br><span class="line">      <span class="keyword">this</span>.refresh();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._equalScroll) &#123;</span><br><span class="line">      <span class="keyword">let</span> gmain = findDOMNode(<span class="keyword">this</span>._gmain);</span><br><span class="line">      <span class="comment">// 弹回</span></span><br><span class="line">      TweenMax.to(gmain, <span class="number">1</span>,</span><br><span class="line">        &#123;<span class="attr">paddingBottom</span>: <span class="keyword">this</span>._gmainDefaultPaddingBottom,</span><br><span class="line">            ease: Power3.easeInOut&#125;);</span><br><span class="line">      <span class="keyword">this</span>.loadMore();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>整个思路就是：通过起始 <code>pageY</code> 和结束 <code>pageY</code> 判断用户垂直滑动方向，在根据 <code>window.scrollY</code> 和保存的上一次滑动位置来判断是否到顶（或者到底），到顶（或者到底）后执行 tansform，touchEnd的时候进行回调。</p>
<p>当然这只是个简单实践，还需要进一步优化，比如：</p>
<ul>
<li>支持传入回调函数。</li>
<li>支持定义限制的上拉下拉高度。</li>
<li>支持上拉下拉时载入自定义的静态资源，如活动动画或是刷新效果等。</li>
<li>设置默认参数。</li>
<li>将TweenMax改为原生方法实现减少大小。</li>
<li>抽取为high-order-component。</li>
<li>最近这种纯前端的东西做的有点多，是时候拿 nodejs 和 express/koa 搞事情了。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhaozeyu.space/2017/01/10/在babel6中使用es7-decorator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zeyu Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Avalon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/10/在babel6中使用es7-decorator/" itemprop="url">在Babel6中使用ES7 Decorator</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-10T00:00:00+08:00">
                2017-01-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在做下拉的时候搜寻到的<a href="http://technologyadvice.github.io/es7-decorators-babel6/" target="_blank" rel="noopener">资料</a>。</p>
<h1 id="增加decorator支持"><a href="#增加decorator支持" class="headerlink" title="增加decorator支持"></a>增加decorator支持</h1><p>*假设你已经安装过 <figure class="highlight plain"><figcaption><span>和 ```babel-preset-react``` 等，并配置完毕。*</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>npm install –save-dev babel-plugin-transform-decorators-legacy<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">然后在 ```.babelrc``` 中添加：</span><br></pre></td></tr></table></figure></p>
<p>{<br>  “plugins”: [“transform-decorators-legacy”]<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">或者在webpack配置文件中：</span><br></pre></td></tr></table></figure></p>
<p>module: {<br>  loaders: [<br>    {<br>      test: /.js$/,<br>      exclude: /node_modules\/(?!(stardust))/,<br>      loader: ‘babel’,<br>      query: {<br>        plugins: [<br>          ‘transform-decorators-legacy’,<br>        ]<br>      },<br>    }<br>  ]<br>}<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 使用方式</span><br><span class="line">在我项目代码中使用了[react-css-modules](https:<span class="comment">//github.com/gajus/react-css-modules)。原来是这样的：</span></span><br><span class="line"></span><br><span class="line">```js</span><br><span class="line"><span class="keyword">import</span> <span class="type">CSSModules</span> from <span class="symbol">'react</span>-css-modules';</span><br><span class="line"><span class="keyword">import</span> styles from <span class="symbol">'app</span>.css';</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="type">Component</span>&#125; from <span class="symbol">'reac</span>t'</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export <span class="keyword">default</span> <span class="type">CSSModules</span>(<span class="type">A</span>, styles, &#123;allowMultiple: <span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure></p>
<p>使用之后是这样的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> CSSModules <span class="keyword">from</span> <span class="string">'react-css-modules'</span>;</span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">'app.css'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;Component&#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line">@CSSModules(styles, &#123;<span class="attr">allowMultiple</span>: <span class="literal">true</span>&#125;)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> A;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>为什么要用decorator？在实现下拉的时候，我就在想，如果能在实现一个动画效果后，能应用到任意组件上就好了，所以才找到了decorator。</p>
<p>参考：</p>
<p>-<a href="http://jamesknelson.com/structuring-react-applications-higher-order-components/" target="_blank" rel="noopener">Structuring React Applications: Higher-Order Components</a></p>
<p>-<a href="https://medium.com/@cheapsteak/reusing-reacttransitiongroup-animations-with-higher-order-components-1e7043451f91#.61d51t159" target="_blank" rel="noopener">Reusing ReactTransitionGroup animations with Higher-order Components</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhaozeyu.space/2016/12/17/2016年年终总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zeyu Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Avalon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/17/2016年年终总结/" itemprop="url">2016年年终总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-17T00:00:00+08:00">
                2016-12-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一年一度的年终总结又开始了，前几年的年终总结要么拖着拖着就没写了，要么就是写了忘了放哪了。今年把之前的博客从国外的托管主机上的WordPress博客放到了github上，然后用七牛去做了一下镜像缓存，码字和发布的体验提升了不少，也就有了那么一点写年终总结的兴致。</p>
<p>今年整个部门最重要的工作就是三大平台的建设，年初我参与了部分WLAN建设工作，之后的主要工作是负责其中一个子中心的前端建设工作。</p>
<h1 id="前端建设"><a href="#前端建设" class="headerlink" title="前端建设"></a>前端建设</h1><blockquote>
<p>我是我行一块砖，哪有需要往哪搬。</p>
</blockquote>
<h2 id="履历背景"><a href="#履历背景" class="headerlink" title="履历背景"></a>履历背景</h2><p>最开始的时候，其实我是做后端的。这里的后端是我们部门成立的时候用Spring、Zookeeper、Dubbo、Quartz等搭建的架构。2013年那时候P2P特别火，我负责的是P2P投资流程的设计和开发。那时候的感触就是，数据库设计中一定的冗余是必要的，范式不一定合适；外系统的东西一定要在接口层隔离；日志要清晰，生产环境不允许debug。</p>
<p>14年的时候部门重构了系统，对各个子项目进行了拆分，这个时候就体现出了设计模式原则的重要性。之前我们就要求尽可能隔离外部系统、外部接口对内部的影响，所以重构的时候基本没有对现有项目产生大的影响。</p>
<p>后来就去做了几个新业务的APP开发，接触了一个非常魔幻的开发框架，是<a href="http://www.rytong.com/?p=1063" target="_blank" rel="noopener">这个公司</a>提供的。该框架是在Objective-C和Java上包了一个lua解释器，使用lua来进行开发。那阵子主要负责跟业务谈需求，然后再用Axure画UE，再盯开发实现和UE、UI有什么差距。</p>
<p>2015年的时候主要是做APP，使用那个魔幻框架，深切感受到了开发工具的重要性。没有高亮、没有自动格式化、没有错误提示、没有自动补全，这样的开发体验非常不友好，极大降低了开发效率，一些设计上的原则和规范也很难顺利执行。</p>
<blockquote>
<p>Q:为什么使用这个框架？A:（假装没听见这个问题）</p>
</blockquote>
<p>年底研究了支付宝、微信支付等接口，在这个魔幻框架上实现了第三方APP和浏览器调起客户端支付的功能。</p>
<p>2016年初主要是参与一个WLAN建设的项目，毕竟我行网点众多，像这种在一般小饭馆提供WiFi服务的项目，规模上去了，就会出现很多问题。</p>
<p>之后，就是建设子中心前端了。</p>
<h2 id="第一版前端"><a href="#第一版前端" class="headerlink" title="第一版前端"></a>第一版前端</h2><p>第一版前端如果从立项开始计算，经历了7个月。从成果上看，是一个APP的四个主页面中的一个页面及其后续流程。对于互联网公司来说，太慢了；但对于我行来说，这是一个了不起的成就了。毕竟，12月开始讨论需求，讨论到了3月底，还要改UE原型。原计划是5月上线，最后推到了6月。</p>
<p>第一版碰到了许多坑，可能有很多我都忘了，得好好想想。这是我接触前端技术的开始，也是接触工程化开始思维侧重点向工程化偏移的开始。</p>
<p>刚开始的时候，大佬说用react吧，Facebook的react很火啊很火啊，我们一堆萌新狂点头好呀好呀你是大佬你说什么都是对的，然后就上了react。DEMO，或者说流行的叫法为starter-kit，迅速搭建了起来，一切看起来很美好。</p>
<h3 id="舍弃AmazeUI"><a href="#舍弃AmazeUI" class="headerlink" title="舍弃AmazeUI"></a>舍弃AmazeUI</h3><p>大佬们说，工期紧啊，用react框架吧！然后找了一个画风看起来小清新的<a href="http://amazeui.org/" target="_blank" rel="noopener">啊妹子UI</a>。</p>
<p>当时的AmazeUI，组件难用，耦合高，使用起来感觉很重，代码质量也不高，而且不方便根据我们的需求进行定制。当然当时react还年轻，各个框架也不成熟，包括阿里的Ant-Design。不是说不好，但这些框架比较适合的还是作为中后台的管理系统前端框架，不适合我们进行定制开发。而且页面可以服用的部分不多，不需要过度追求组件化。</p>
<p>于是乎，我们就把啊妹子UI舍弃了。</p>
<p><em>后期啊妹子UI好像招到了一个比较牛的人，整个画风都不一样了。</em></p>
<h3 id="全站HTTPS"><a href="#全站HTTPS" class="headerlink" title="全站HTTPS"></a>全站HTTPS</h3><p>放公网测试的时候，发生了一件非常尴尬的事情。运营商真是非常牛逼的，一言不合就往你的页面塞广告。这我能怎么办呢？没办法，全站HTTPS吧。</p>
<h3 id="地理位置定位"><a href="#地理位置定位" class="headerlink" title="地理位置定位"></a>地理位置定位</h3><p>一般浏览器中使用的为IP定位和window.navigator.geolocation来获取经纬度定位。IP定位不准，geolocation定位受限于浏览器（webview）内核，如果用户刷机，甚至可能无法连接定位服务（被墙你懂的）。</p>
<p>那么，使用百度地图JS API吧！然后换全站HTTPS之后，百度地图JS API出现各种问题。</p>
<p><em>高德没有试过，有机会可以试试。</em></p>
<p>还好有万能的第三方APP提供他们的定位接口，才能解决这个定位问题。</p>
<h3 id="第三方APP内的路由"><a href="#第三方APP内的路由" class="headerlink" title="第三方APP内的路由"></a>第三方APP内的路由</h3><p>这又是个神奇的问题。在第三方APP里，你是要调用APP提供的接口来登录和支付的。调用登录和支付，会切换webview，导致原生的history返回出错。同时，第三方给的入口页面有第三方自己的header和footer，进入二级页面也会切换webview。</p>
<p>只能自己记录一个栈，实现自己的返回方法了。简单来说就是在本地记录一个访问栈，每次访问新页面的时候把地址压入栈，返回的时候出栈。第一版使用的是Cookie，在react-router的onEnter方法中注入，避免路由影响页面部分的开发。</p>
<p>这个方法存在一定的问题，难以记录当前页面状态，如多个页面的表单填写，需要保存当前表单的填写字段时，或是一个列表做了筛选操作时，需要做一定的特殊处理；需要清理Cookie；Cookie在会带入请求增加请求大小等。</p>
<h3 id="开发部署流程改进"><a href="#开发部署流程改进" class="headerlink" title="开发部署流程改进"></a>开发部署流程改进</h3><p>初始的starter-kit中，虽然在webpack的配置文件里配置了css-loader、style-loader、url-loader来处理样式、图片等资源，但在实际使用过程中，只在入口html文件里引入了样式文件 <code>&lt;link src=&quot;app.css&quot;&gt;</code> ，并没有考虑css、图片的压缩、优化等处理。为了将css、图片等资源纳入管理，使用了inline css方式，将css、图片也像js一样引入进来，并使用loader来处理，编写了示例代码，修改了文件输出方式增加了哈希值。</p>
<p>因为我厂采用的是采购外部厂商设计UI实现静态页面，我们利用静态页面来开发的合作方式，引入了react-css-modules来处理样式，避免编写内联样式，优化开发体验。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>产品上线使用，初步搭建了前端开发部署框架和规范化的流程。</li>
<li>存在一些优化方面的问题。</li>
<li>路由全部由前端控制，使用的hashHistory，没有后端渲染。没有自动化测试。</li>
<li>没有执行Eslint。</li>
</ul>
<h2 id="第二版前端"><a href="#第二版前端" class="headerlink" title="第二版前端"></a>第二版前端</h2><p>第二版前端主要在第一版基础上进行了一些改造。</p>
<h3 id="替换为browserHistory"><a href="#替换为browserHistory" class="headerlink" title="替换为browserHistory"></a>替换为browserHistory</h3><blockquote>
<p>#后面应该是锚点，url应该就是/，为什么路由要用#？2016年了还#，你这是搞事情！</p>
</blockquote>
<p>代码洁癖：保持和最广泛的规范一致，不要搞事情。</p>
<p>修改点：</p>
<ul>
<li>前后端的uri前缀配置。</li>
<li>页面跳转方式使用browserHistory.push。</li>
<li>修改打包时各种静态资源的相对路径注入方式。</li>
</ul>
<h3 id="修改跨页面变量存储方式"><a href="#修改跨页面变量存储方式" class="headerlink" title="修改跨页面变量存储方式"></a>修改跨页面变量存储方式</h3><p>封装了Cookie和localStorage，自动判断本地是否支持localStorage，优先使用localStorage；如果强制要求使用Cookie则使用Cookie。</p>
<h3 id="抽取第三方APP相关的接口代码"><a href="#抽取第三方APP相关的接口代码" class="headerlink" title="抽取第三方APP相关的接口代码"></a>抽取第三方APP相关的接口代码</h3><p>将路由、登录、支付代码从页面代码和内部公共代码部分抽离，以备后期代码复用时配置化管理。</p>
<h3 id="部署配置纳入管理"><a href="#部署配置纳入管理" class="headerlink" title="部署配置纳入管理"></a>部署配置纳入管理</h3><p>最近投产发生了替换静态资源后大面积出现404的问题，原因是之前应该投产的配置文件修改由于种种原因没有投产，导致出错。现将配置文件纳入管理。</p>
<h1 id="团队建设"><a href="#团队建设" class="headerlink" title="团队建设"></a>团队建设</h1><p>严格来说，技术团队的建设谈不上特别复杂，相对来说比较单纯——你技术强大家就会听你的。只不过在我们的开发中技术团队的构成比较复杂一点：</p>
<ul>
<li>成员构成为我、入职新人、厂商的驻场开发人员。</li>
<li>前端开发由另外的厂商提供静态页面，再由上述三类开发人员开发。</li>
</ul>
<p>按照“看山”的分法，大部分的开发人员停留在“看山是山”的程度，并不了解隐藏在背后的思量。作为前端建设的负责人，我不可能也不应该完成前端的大部分编码，而是要挑选适合的人选进行培养，然后在保证质量的前提上，提高团队工作的效率，减少bug率，提高整个团队的水准。</p>
<p>实际上，我并没有特地对人员进行培养，只是提供了不少参考文档和示例代码，布置了一些开发任务，然后期待他们的主观能动性。如何培养人才？这方面一直是我欠缺的，希望来年在这方面多下功夫。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhaozeyu.space/2016/12/07/x-www-form-urlencoded和json/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zeyu Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Avalon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/07/x-www-form-urlencoded和json/" itemprop="url">x-www-form-urlencoded、json和@RequestParam、@RequestBody</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-07T00:00:00+08:00">
                2016-12-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>临近下班碰到新人有个bug找不到原因，症状是发送了ajax请求后后台收不到数据。经过跟踪，发现请求头为</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">Accept:*/*</span></span><br><span class="line"><span class="section">Accept-Encoding:gzip, deflate, br</span></span><br><span class="line"><span class="section">Accept-Language:zh-CN,zh;q=0.8,ja;q=0.6,en-US;q=0.4,en;q=0.2,zh-TW;q=0.2</span></span><br><span class="line"><span class="section">Connection:keep-alive</span></span><br><span class="line"><span class="section">Content-Length:112</span></span><br><span class="line"><span class="section">Content-Type:application/json</span></span><br></pre></td></tr></table></figure>
<p>而后台使用Spring-MVC。Controller中的获取报文方式为@RequestParam。这是导致无法接受到参数的原因。</p>
<h1 id="RequestParam和-RequestBody"><a href="#RequestParam和-RequestBody" class="headerlink" title="@RequestParam和@RequestBody"></a>@RequestParam和@RequestBody</h1><p>@RequestParam为Spring提供的注解，对应处理String类型的body参数，如 <code>a=1&amp;b=2</code> 这类。</p>
<p>@RequestBody同为Spring提供的注解，对应处理非String类型的body参数，如json。</p>
<p>以上需要在Spring里进行配置。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zhaozeyu.space/2016/11/08/在ios-app内部使用js访问webview时uri的查询参数需要encode两次/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zeyu Zhao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Avalon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/08/在ios-app内部使用js访问webview时uri的查询参数需要encode两次/" itemprop="url">在iOS APP内部使用JS访问webview时uri的查询参数需要encode两次</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-08T00:00:00+08:00">
                2016-11-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>最近在使用开发运行于第三方APP内的SPA时，需要打开浏览器访问百度地图。APP提供了一个 <figure class="highlight plain"><figcaption><span>的格式，可以在webview内使用 ```window.location.href </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 问题</span><br><span class="line">使用 ```[prefix-to-open-browser]/https://www.baidu.com``` 时没有问题，但uri中包含中文参数时，使用 ```encodeURI([uri])``` 无法打开浏览器。</span><br><span class="line"></span><br><span class="line"># 跟踪</span><br><span class="line">在浏览器中进行测试，```encodeURI``` 确实能将uri中的字符串进行编码：</span><br></pre></td></tr></table></figure></p>
<p>encodeURI之前：<a href="https://www.baidu.com/s?wd=编码" target="_blank" rel="noopener">https://www.baidu.com/s?wd=编码</a></p>
<p>encodeURI之后：<a href="https://www.baidu.com/s?wd=%E7%BC%96%E7%A0%81" target="_blank" rel="noopener">https://www.baidu.com/s?wd=%E7%BC%96%E7%A0%81</a><br><code>`</code></p>
<p>而在APP内部获取到的却是 <code>https://www.baidu.com/s?wd=编码</code>，导致APP无法打开浏览器。</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>最后在浏览器中发现，<strong>encodeURI之后，在浏览器中访问时，会自动decodeURI一次</strong>。在使用两次encodeURI之后，就解决了这个问题。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Zeyu Zhao</p>
              <p class="site-description motion-element" itemprop="description">中年危机攻城狮的小圆子，Java，JavaScript，Spring，ReactJS，摄影，一些小东西。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">36</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zeyu Zhao</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
